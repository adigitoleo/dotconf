#!/bin/sh
set -eu
readonly SCRIPTNAME="${0##*/}"
usage() {
    printf 'Usage: %s [-h]\n' "$SCRIPTNAME"
    printf '       %s ' "$SCRIPTNAME"
    echo '[-d DIR][-f FILE]'
}
helpf() {
    echo 'Options:'
    echo '  -d <dir>        Specify destination directory for ICS downloads'
    echo '  -f <file>       Specify alternate config file location'
    echo
    echo 'Download ICS calendars from the sources specified in'
    echo '$XDG_CONFIG_HOME/get-calendars/calendars.conf,'
    echo 'falling back to $HOME/.config/get-calendars/calendars.conf instead.'
}

DIR=
CFG=
while getopts "hd:f:" OPT; do
    case "$OPT" in
        h ) usage && helpf ; exit 0 ;;
        d ) DIR="$OPTARG" ;;
        f ) CFG="$OPTARG" ;;
        * ) usage ; exit 1 ;;
    esac
done
shift $(( OPTIND - 1 ))

CFG_DIR="${XDG_CONFIG_HOMEf:-$HOME/.config}/get-calendars"
CFG="${CFG:-$CFG_DIR/calendars.conf}"
DIR="${DIR:-$HOME/Downloads}"

# Calcurse --import is too stupid and creates duplicate appointments...
# Need to nuke the existing appointments file first (make a backup).
APTS_FILE=${XDG_DATA_HOME:-$HOME/.local/share}/calcurse/apts
mv -i "$APTS_FILE" "$APTS_FILE".bak

while IFS= read -r line || [ -n "$line" ]; do
    IFS=' ' read -r file url <<EOF
    $line
<<
EOF
    ( cd "$DIR"; curl --output "$file" --location --continue-at - "$url" )
    calcurse --import "$DIR"/"$file"
done < "$CFG"
