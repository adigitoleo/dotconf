#!/usr/bin/sh
# Bubblewrap launcher for sandboxed imv on wayland.
# Refuses to open a file that is already open in another instance.


eval doc=\${$#}

ps fh -ocmd -Cimv-wayland|grep "${doc##*/}" >/dev/null 2>&1 && exit 1

bwrap \
    --ro-bind /usr /usr \
    --symlink usr/bin /bin --symlink usr/bin /sbin \
    --symlink usr/lib /lib --symlink usr/lib /lib64 \
    --tmpfs usr/share/zoneinfo \
    --tmpfs usr/share/zoneinfo-leaps \
    --tmpfs usr/share/zoneinfo-posix \
    --tmpfs usr/share/locale \
    --tmpfs usr/share/hwdata \
    --tmpfs usr/share/hwloc \
    --proc /proc \
    --dev-bind /dev/dri/card1 /dev/dri/card1 \
    --ro-bind /run/user/"$(id -u)"/wayland-0 /run/user/"$(id -u)"/wayland-0 \
    --ro-bind /etc/fonts /etc/fonts \
    --ro-bind ~/.cache/fontconfig /home/fake/.cache/fontconfig \
    --ro-bind ~/.config/fontconfig /home/fake/.config/fontconfig \
    --ro-bind $doc /home/fake/"${doc##*/}" \
    --unshare-all \
    --unsetenv SSH_AUTH_SOCK --unsetenv SSH_AGENT_PID \
    --unsetenv DBUS_SESSION_BUS_ADDRESS \
    --setenv LOGNAME fake \
    --setenv USER fake \
    --setenv LANG "en_US.UTF-8" \
    --setenv HOME /home/fake \
    --setenv MAIL /var/spool/mail/fake \
    --setenv PATH /usr/bin:/bin:/usr/local/sbin:/usr/local/bin:/usr/bin/site_perl:/usr/bin/vendor_perl:/usr/bin/core_perl \
    --new-session \
    imv-wayland "${doc##*/}"
