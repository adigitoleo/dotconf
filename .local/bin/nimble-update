#!/bin/sh
set -eu
readonly SCRIPTNAME="${0##*/}"

warn() { >&2 printf '%s\n' "$SCRIPTNAME: $1"; }
tell() { printf '%s\n' "$SCRIPTNAME: $1"; }
ask() {
    default=0
    choices="[y]/n"
    if [ $2 -eq 1 ]; then
        default=1
        choices="y/[n]"
    fi
    printf '%s: %s %s: ' "$SCRIPTNAME" "$1" "$choices"
    read answer
    case $answer in
        y|Y ) return 0;;
        n|N ) return 1;;
        * ) return $default;;
    esac
}
is_command() {
    if 1>/dev/null 2>&1 command -v "$1"; then
        return 0
    else
        warn "command '$1' not found"; return 1
    fi
}

is_command nimble || exit 1

TOTAL=0
nimble list --installed|while IFS= read -r line || [ -n "$line" ]; do
    echo "$line"
    TOTAL=$((TOTAL + 1 ))
done

ask "re-install $TOTAL nim packages" 1 || exit 1
nimble refresh
nimble list --installed|while IFS= read -r line || [ -n "$line" ]; do
    nimble -y install "${line%% *}"
done
