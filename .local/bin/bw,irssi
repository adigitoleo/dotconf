#!/bin/sh
# Bubblewrap launcher for sandboxed irssi on wayland.

pgrep -x irssi >/dev/null 2>&1 && exit 1

# Create fake home dir to receive files over scp or similar.
[ -d $HOME/bubblewrap ] || mkdir $HOME/bubblewrap
[ -d $HOME/bubblewrap/env-irssi ] || mkdir $HOME/bubblewrap/env-irssi

bwrap \
    --ro-bind /usr /usr \
    --symlink usr/bin /bin --symlink usr/bin /sbin \
    --symlink usr/lib /lib --symlink usr/lib /lib64 \
    --tmpfs usr/share/zoneinfo \
    --tmpfs usr/share/zoneinfo-leaps \
    --tmpfs usr/share/zoneinfo-posix \
    --tmpfs usr/share/locale \
    --tmpfs usr/share/hwdata \
    --tmpfs usr/share/hwloc \
    --ro-bind /opt /opt \
    --dev /dev \
    --proc /proc \
    --tmpfs /var \
    --tmpfs /tmp \
    --tmpfs /run --dir /run/user/"$(id -u)" \
    --ro-bind /run/user/"$(id -u)"/wayland-0 /run/user/"$(id -u)"/wayland-0 \
    --ro-bind /run/systemd/resolve/stub-resolv.conf /run/systemd/resolve/stub-resolv.conf \
    --ro-bind /etc/resolv.conf /etc/resolv.conf \
    --ro-bind /etc/ca-certificates /etc/ca-certificates \
    --ro-bind /etc/ssl/certs /etc/ssl/certs \
    --bind ~/bubblewrap/env-irssi /home/fake \
    --ro-bind ~/.irssi /home/fake/.irssi \
    --unshare-all \
    --share-net \
    --unsetenv SSH_AUTH_SOCK --unsetenv SSH_AGENT_PID \
    --unsetenv DBUS_SESSION_BUS_ADDRESS \
    --setenv LOGNAME fake \
    --setenv USER fake \
    --setenv LANG "en_US.UTF-8" \
    --setenv HOME /home/fake \
    --setenv MAIL /var/spool/mail/fake \
    --setenv PATH /usr/bin:/bin:/usr/local/sbin:/usr/local/bin:/usr/bin/site_perl:/usr/bin/vendor_perl:/usr/bin/core_perl \
    --new-session \
     irssi "$@"
